@page "/sjednani-schuzky/{Id:guid}"
@using Calendar.Users
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject UserService UserService

@if (_isUsed)
{
  <p>Tento odkaz již byl použit.</p>
}
else if (_loading)
{
  <p>Načítám data…</p>
}
else
{
  <h1 class="mb-4 text-4xl font-extrabold tracking-tight text-gray-800 focus-visible:outline-none ">
    Sjednat schůzku s @Owner.GetNameWithAbbreviatedLastName()
  </h1>
  <div id="calendar" class="w-4/5"></div>
}

<dialog id="meetingDialog"
        class="p-6 rounded-lg fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
  <h4>Nová schůzka</h4>
  <p>Den: @_selectedDate?.ToShortDateString()</p>
  <div>
    <label class="block mb-2 font-medium">Délka schůzky:</label>
    <div class="space-x-4">
      @foreach (var duration in new[] { 30, 45, 60 })
      {
        <label class="inline-flex items-center">
          <input type="radio"
                 name="duration"
                 value="@duration"
                 @onchange="@(e => OnDurationChange(duration))"
                 class="mr-2"/>
          @(duration == 60 ? "1 hodina" : $"{duration} minut")
        </label>
      }
    </div>
  </div>

  @if (_availableSlots != null)
  {
    <div>
      <label class="block mb-2 font-medium">Dostupné časy:</label>
      <div class="space-y-2 max-h-48 overflow-y-auto">
        @foreach (var slot in _availableSlots)
        {
          <label class="block">
            <input type="radio"
                   name="timeSlot"
                   value="@slot.StartTime.ToString("HH:mm")"
                   disabled="@(!slot.IsAvailable)"
                   @onchange="@(e => OnTimeSlotSelect(slot))"
                   class="mr-2"/>
            <span class="@(!slot.IsAvailable ? "text-gray-400" : "")">
              @slot.StartTime.ToString("HH:mm")-@slot.EndTime.ToString("HH:mm")
              @(slot.Status switch
              {
                "occupied" => " (obsazeno)",
                "unavailable" => " (nedostupné)",
                _ => ""
              })
            </span>
          </label>
        }
      </div>
    </div>
  }

  @if (_selectedTimeSlot != null)
  {
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
      <input id="email"
             type="email"
             @bind-value="_newMeeting.ParticipantEmail"
             @bind-value:event="oninput"
             class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
    </div>

    <div class="space-y-4">
      <div>
        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Jméno</label>
        <input id="firstName"
               type="text"
               @bind="_newMeeting.ParticipantFirstName"
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
      </div>

      <div>
        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Příjmení</label>
        <input id="lastName"
               type="text"
               @bind="_newMeeting.ParticipantLastName"
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
      </div>


      <div class="flex justify-around space-x-2 pt-4">
        <button class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
                @onclick="CloseDialog">
          Zrušit
        </button>
        <button
          class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          @onclick="CreateMeeting"
          disabled="@(!CanCreateMeeting())">
          Vytvořit schůzku
        </button>
      </div>
    </div>
  }
</dialog>


<script>
  function show() {
    document.getElementById('meetingDialog').showModal();
  }

  function close() {
    document.getElementById('meetingDialog').close();
  }
</script>

@code {

  // TODO Jit postupne:
  // 1. Dat dialog doprosted a udelat ho trochu hezky DONE
  // 2. Radiobox s 30 45 60 DONE
  // 3. Generovani timeslotu na zaklade radioboxu DONE
  // 4. Jmeno a prijmeni a email DONE
  // 5. Validace
  [Parameter] public Guid Id { get; set; }

  private bool _isUsed;
  private bool _loading = true;
  private List<PrivateMeeting> _existingMeetings = new();
  private NewMeetingDto _newMeeting = new();
  private User Owner { get; set; } = null!;

  private List<TimeSlot>? _availableSlots;
  private TimeSlot? _selectedTimeSlot;
  private DateTime? _selectedDate;
  private int _selectedDurationMinutes;

  [Inject] MeetingService MeetingService { get; set; } = null!;

  protected override async Task OnInitializedAsync()
  {
    var link = await MeetingService.GetMeetingLinkAsync(Id);
    if (link == null || link.IsUsed)
    {
      _isUsed = true;
      return;
    }

    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync(); // TODO Tohle dat do User Service. Pouziva se to i v Home.razor
    var user = authState.User;
    if (user.Identity?.IsAuthenticated == true)
    {
      var currentUserId = user.FindFirst(c => c.Type == "UserId")?.Value;
      if (link.UserId.ToString() == currentUserId)
      {
        NavigationManager.NavigateTo("/");
        return;
      }
    }

    Owner = (await UserService.GetUserAsync(link.UserId))!; // Tady se User urcite nevrati.
    _existingMeetings = await MeetingService.GetUserMeetingsForMonthAsync(link.UserId, DateTime.UtcNow);
    _loading = false;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!_isUsed && !_loading)
    {
      var events = _existingMeetings.Select(meeting => new { title = "Schůzka", start = meeting.ScheduledAt.ToString("yyyy-MM-dd") });
      await JS.InvokeVoidAsync("fullCalendarInterop.initCalendar", "calendar", events, DotNetObjectReference.Create(this));
    }
  }

  private async Task ShowDialog()
  {
    await JS.InvokeVoidAsync("show");
  }

  private async Task CloseDialog()
  {
    _selectedTimeSlot = null;
    _availableSlots = null;
    _selectedDurationMinutes = 0;
    await JS.InvokeVoidAsync("close");
  }

  [JSInvokable]
  public async Task OnDateClick(string dateStr)
  {
    _selectedDate = DateTime.Parse(dateStr);
    StateHasChanged();
    await ShowDialog();
  }


  private async Task OnDurationChange(int minutes)
  {
    _selectedDurationMinutes = minutes;
    await GenerateAvailableSlots();
  }

  private Task GenerateAvailableSlots()
  {
    if (_selectedDate == null) return Task.CompletedTask;

    var date = _selectedDate.Value;
    _availableSlots = [];

    var currentTime = new DateTime(date.Year, date.Month, date.Day, 9, 0, 0);
    var endTime = new DateTime(date.Year, date.Month, date.Day, 16, 0, 0);

    while (currentTime.AddMinutes(_selectedDurationMinutes) <= endTime)
    {
      var slot = new TimeSlot
      {
        StartTime = currentTime,
        EndTime = currentTime.AddMinutes(_selectedDurationMinutes),
        IsAvailable = true,
        Status = "available"
      };

      if (_existingMeetings.Any(meeting => IsTimeSlotOverlapping(slot, meeting)))
      {
        slot.IsAvailable = false;
        slot.Status = "occupied";
      }

      _availableSlots.Add(slot);
      currentTime = currentTime.AddMinutes(15);
    }

    StateHasChanged();
    return Task.CompletedTask;
  }

  private static bool IsTimeSlotOverlapping(TimeSlot slot, PrivateMeeting meeting)
  {
    return slot.StartTime < meeting.ScheduledAt.AddMinutes(meeting.DurationMinutes + 15) &&
           slot.EndTime > meeting.ScheduledAt.AddMinutes(-15);
  }

  private void OnTimeSlotSelect(TimeSlot slot)
  {
    _selectedTimeSlot = slot;
  }

  private bool CanCreateMeeting()
  {
    return _selectedTimeSlot != null &&
           !string.IsNullOrWhiteSpace(_newMeeting.ParticipantFirstName) &&
           !string.IsNullOrWhiteSpace(_newMeeting.ParticipantLastName) &&
           !string.IsNullOrWhiteSpace(_newMeeting.ParticipantEmail);
  }


  private async Task CreateMeeting()
  {
    if (_selectedTimeSlot == null) return;

    _newMeeting.ScheduledAt = _selectedTimeSlot.StartTime;
    _newMeeting.DurationMinutes = _selectedDurationMinutes;
    _newMeeting.ParticipantFirstName = _newMeeting.ParticipantFirstName;
    _newMeeting.ParticipantLastName = _newMeeting.ParticipantLastName;
    _newMeeting.ParticipantEmail = _newMeeting.ParticipantEmail;

    await MeetingService.CreateMeetingAsync(Id, _newMeeting);
    await MeetingService.MarkLinkAsUsedAsync(Id);

    await JS.InvokeVoidAsync("fullCalendarInterop.addEvent", "calendar", new
    {
      title = $"Vaše schůzka s {Owner.GetNameWithAbbreviatedLastName()}",
      start = _selectedTimeSlot.StartTime.ToString("yyyy-MM-ddTHH:mm:ss"),
      end = _selectedTimeSlot.EndTime.ToString("yyyy-MM-ddTHH:mm:ss"),
      color = "green"
    });

    await CloseDialog();
  }

}